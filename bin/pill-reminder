#!/usr/bin/env node

console.log('Executando scheduled job');

console.log('Criando BOT' + process.env.TELEGRAM_BOT_TOKEN);
var TelegramBot = require('node-telegram-bot-api');
var bot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, {polling: true});
console.log('BOT criado');

console.log('Instanciando e conectando no MongoDB' + process.env.MONGOLAB_URI);
var mongoose = require('mongoose');
mongoose.connect(process.env.MONGOLAB_URI, function (error) {
    if (error) console.error(error);
    else console.log('mongo connected');
});

function pillReminder() {
  console.log('Executando task');
  var ReminderTelegram = mongoose.model('ReminderTelegram', { chatId: String });

  ReminderTelegram.find(function(err, objs){
    console.log('Find executado. Obj de erro: ', err);  
    console.log('Find executado. Obj de retorno do find: ', objs);  
    objs.forEach(function(item){
        console.log('Enviando mensagem');
        bot.sendMessage(item._doc.chatId, "Vai tomar o rem√©dio...");
    });
  });
}

pillReminder();
process.exit();
