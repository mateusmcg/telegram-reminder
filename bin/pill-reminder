#!/usr/bin/env node

var TelegramBot = require('node-telegram-bot-api');
var mongoose = require('mongoose');
var Models = require('../database/models/models');

console.log('Executando scheduled job');

var bot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN);
var db = mongoose.connection;

db.on('error', console.error);
db.once('open', function () {
  console.log('Executando task');

  Models.PillReminder.find(function (err, docs) {
    console.log('Find executado. Obj de retorno do find: ', docs);
    docs.each(function (doc) {
      if (doc.daysInPause == 8) {
        doc.update({ daysInPause: 0, days: 0, pause: false });
        bot.sendMessage(doc.chatId, doc.userName + ', hoje foi seu última dia de pausa. Amanhã você voltará a receber as notificações.').then(function () { })
        return;
      }

      if (doc.pause) {
        console.log('Serviço em pausa, não enviando mensagem.', doc);
        doc.update({ daysInPause: doc.daysInPause + 1 });
      } else {
        console.log('Enviando mensagem: ', doc);
        doc.update({ days: doc.days + 1 });
        bot.sendMessage(doc.chatId, doc.alertMessage ? doc.alertMessage : process.env.TELEGRAM_BOT_MESSAGE).then(function () { })

        if (doc.days + 1 == 21) {
          bot.sendMessage(doc.chatId, doc.userName + ', você chegou ao último dia! Deseja fazer a pausa ou emendar a otra cartela?', {
            reply_markup: JSON.stringify({
              inline_keyboard: [
                [{ text: 'Emendar', callback_data: '01-Emendar' }],
                [{ text: 'Pausar', callback_data: '02-Pausar' }]
              ]
            })
          }).then(function (messageSent) { })
        }
      }
    });
  });
});

mongoose.connect(process.env.MONGOLAB_URI);
